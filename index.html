<!doctype html>
<html>
  <head>
    <style>
      /* Basic layout */
      #container,
      #mainMenu {
        height: 100vh;
        display: flex;
      }
      html {
        font-family: Roboto;
      }
      #mainMenu {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100vw;
        background-color: #fff;
        position: absolute;
        z-index: 20;
      }
      #gameOptions {
        display: flex;
        flex-direction: column;
        margin-top: 20px;
      }
      /* Multiplayer options – only show when Multiplayer Mode is checked */
      #multiplayerOptions {
        display: none;
      }
      #map,
      #pano {
        flex: 1;
        display: none;
      }
      #distanceButton,
      #forfeitButton,
      #timer {
        position: absolute;
        right: 10px;
        background-color: #fff;
        padding: 10px;
        border: none;
        cursor: pointer;
      }
      #distanceButton {
        top: 10px;
      }
      #timer {
        top: 100px;
      }
      #forfeitButton {
        top: 50px;
      }
      #gameOverDistanceDialog,
      #loadingDialog {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        background-color: #fff;
        padding: 20px;
        border: 1px solid #ccc;
        display: none;
      }
      #startButton {
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 20px;
        margin-top: 10px;
        cursor: pointer;
      }
    </style>
    <title>GeoPlacer – Optimized Multiplayer Code</title>
  </head>
  <body>
    <div id="mainMenu">
      <h1>GeoPlacer</h1>
      <div id="gameOptions">
        <label><input type="checkbox" id="timedMode"> Timed Mode</label>
        <div id="timerOptions" style="display:none">
          <label>Timer Duration (seconds): 
            <input type="number" id="timerDuration" value="60" min="6" max="3600">
          </label>
        </div>
        <label><input type="checkbox" id="hardMode"> Hard Mode (No City Check)</label>
        <label><input type="checkbox" id="noNavLinksMode"> No Nav-Links Mode</label>
        <label><input type="checkbox" id="staticFrameMode"> Static Frame Mode</label>
        <label><input type="checkbox" id="multiplayerMode"> Multiplayer Mode</label>
        <div id="multiplayerOptions">
          <label>
            Multiplayer Code (optional): 
            <input type="text" id="multiplayerCode" placeholder="Enter 7-character code">
          </label>
        </div>
      </div>
      <button onclick="startGame()" id="startButton">Start Game</button>
    </div>
    <div id="container">
      <div id="pano"></div>
      <div id="map"></div>
    </div>
    <button id="distanceButton" onclick="checkDistance()">Check Distance</button>
    <button id="forfeitButton" onclick="forfeit()">Forfeit</button>
    <button id="timer"></button>
    <div id="loadingDialog">Loading...</div>
    <div id="gameOverDistanceDialog">
      <span id="resultText"></span><br>
      <!-- Next Map button appears only in multiplayer mode -->
      <button id="nextMapButton" style="display:none" onclick="nextMap()">Next Map</button>
      <button onclick="reopenMainMenu()">Main Menu</button>
    </div>
    <!-- Google Maps API – be sure to supply your own API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&callback=initialize&v=weekly" defer="defer"></script>
  </body>
</html>
<script>
  /***********************
   * Global Variables
   ***********************/
  let streetViewLatLng, userMarker, actualMarker, map, panorama, timerInterval;
  // Game settings (timerDuration is now in seconds)
  let isTimedMode = false, isHardMode = false, timerDuration;
  let isMultiplayerMode = false;
  let isStaticMode = false, isNoNavLinksMode = false;
  // Seed for our RNG – will be set from the multiplayer code or generated
  let currentSeed = 0;

  /***********************
   * Seeded Random Number Generator
   * (Simple linear congruential generator)
   ***********************/
  function seededRandom() {
    currentSeed = (currentSeed * 9301 + 49297) % 233280;
    return currentSeed / 233280;
  }

  /***********************
   * Initialization and UI Helpers
   ***********************/
  function initialize() {
    showLoadingDialog(true);
    findRandomStreetView();
  }
  function showLoadingDialog(show) {
    document.getElementById("loadingDialog").style.display = show ? "block" : "none";
  }
  function showGameOverDistanceDialog(message) {
    document.getElementById("resultText").textContent = message;
    document.getElementById("gameOverDistanceDialog").style.display = "block";
  }
  function closeGameOverDistanceDialog() {
    document.getElementById("gameOverDistanceDialog").style.display = "none";
  }

  /***********************
   * Game Controls
   ***********************/
  function forfeit() {
    resetGame();
    document.getElementById("mainMenu").style.display = "flex";
    document.getElementById("container").style.display = "none";
    document.getElementById("distanceButton").style.display = "none";
    document.getElementById("timer").style.display = "none";
    document.getElementById("forfeitButton").style.display = "none";
    clearInterval(timerInterval);
  }

  // When starting the game, if Multiplayer Mode is enabled, we either parse a 7‑character code or generate one.
  function startGame() {
    document.getElementById("mainMenu").style.display = "none";
    document.getElementById("container").style.display = "flex";
    document.getElementById("distanceButton").style.display = "block";
    document.getElementById("timer").style.display = "block";
    document.getElementById("forfeitButton").style.display = "block";

    isMultiplayerMode = document.getElementById("multiplayerMode").checked;
    if (isMultiplayerMode) {
      let codeInput = document.getElementById("multiplayerCode").value.trim();
      if (codeInput) {
        // Remove spaces and expect exactly 7 characters.
        codeInput = codeInput.replace(/\s/g, "");
        if (codeInput.length !== 7) {
          alert("Invalid multiplayer code. Must be 7 characters.");
          return;
        }
        // Decode the 7-character code:
        // • First 4 characters (base36) = seed
        // • 5th character (hex) = toggles (4 bits)
        // • Last 2 characters (base36) = timer (in 6-second increments)
        let seedStr = codeInput.slice(0, 4);
        let toggleStr = codeInput.slice(4, 5);
        let timerStr = codeInput.slice(5, 7);
        currentSeed = parseInt(seedStr, 36);
        let toggleVal = parseInt(toggleStr, 16);
        isHardMode = Boolean(toggleVal & 8);
        isTimedMode = Boolean(toggleVal & 4);
        isStaticMode = Boolean(toggleVal & 2);
        isNoNavLinksMode = Boolean(toggleVal & 1);
        let timerIncrements = parseInt(timerStr, 36);
        timerDuration = timerIncrements * 6; // in seconds
        // Update the UI checkboxes and timer input accordingly.
        document.getElementById("hardMode").checked = isHardMode;
        document.getElementById("timedMode").checked = isTimedMode;
        document.getElementById("staticFrameMode").checked = isStaticMode;
        document.getElementById("noNavLinksMode").checked = isNoNavLinksMode;
        document.getElementById("timerDuration").value = timerDuration;
      } else {
        // No code was entered – generate one.
        // Generate a 4‑character seed (base36).
        currentSeed = Math.floor(Math.random() * (36 ** 4));
        let seedCode = currentSeed.toString(36).toUpperCase().padStart(4, "0");
        // Read the toggles from the UI.
        isHardMode = document.getElementById("hardMode").checked;
        isTimedMode = document.getElementById("timedMode").checked;
        isStaticMode = document.getElementById("staticFrameMode").checked;
        isNoNavLinksMode = document.getElementById("noNavLinksMode").checked;
        // Pack the four toggles into a 4‑bit value:
        // Bit 3: hard mode, Bit 2: timed mode, Bit 1: static mode, Bit 0: no‑nav links.
        let toggleVal = 0;
        if (isHardMode) toggleVal |= 8;
        if (isTimedMode) toggleVal |= 4;
        if (isStaticMode) toggleVal |= 2;
        if (isNoNavLinksMode) toggleVal |= 1;
        let toggleCode = toggleVal.toString(16).toUpperCase();
        // Get the timer (in seconds) from the UI.
        timerDuration = parseInt(document.getElementById("timerDuration").value, 10);
        if (timerDuration < 6) timerDuration = 6;
        if (timerDuration > 3600) timerDuration = 3600;
        // Represent the timer as a number of 6‑second increments.
        let timerIncrements = Math.floor(timerDuration / 6);
        let timerCode = timerIncrements.toString(36).toUpperCase().padStart(2, "0");
        let fullCode = seedCode + toggleCode + timerCode;
        alert("Share this multiplayer code with your friend:\n" + fullCode);
      }
    } else {
      // Single‑player: generate a seed and read toggles from the UI.
      currentSeed = Math.floor(Math.random() * (36 ** 4));
      isHardMode = document.getElementById("hardMode").checked;
      isTimedMode = document.getElementById("timedMode").checked;
      isStaticMode = document.getElementById("staticFrameMode").checked;
      isNoNavLinksMode = document.getElementById("noNavLinksMode").checked;
      timerDuration = parseInt(document.getElementById("timerDuration").value, 10);
      if (timerDuration < 6) timerDuration = 6;
      if (timerDuration > 3600) timerDuration = 3600;
    }
    resetGame();
    if (isTimedMode) {
      startTimer(timerDuration);
    } else {
      startStopwatch();
    }
    showLoadingDialog(true);
    findRandomStreetView();
  }

  /***********************
   * Timer / Stopwatch Functions
   ***********************/
  function startTimer(seconds) {
    let t = seconds, minutes, secs;
    timerInterval = setInterval(function() {
      minutes = parseInt(t / 60, 10);
      secs = parseInt(t % 60, 10);
      minutes = minutes < 10 ? "0" + minutes : minutes;
      secs = secs < 10 ? "0" + secs : secs;
      document.getElementById("timer").textContent = minutes + ":" + secs;
      if (--t < 0) {
        clearInterval(timerInterval);
        endGame();
      }
    }, 1000);
  }
  function startStopwatch() {
    let e = 0, minutes, secs;
    timerInterval = setInterval(function() {
      minutes = parseInt(e / 60, 10);
      secs = parseInt(e % 60, 10);
      minutes = minutes < 10 ? "0" + minutes : minutes;
      secs = secs < 10 ? "0" + secs : secs;
      document.getElementById("timer").textContent = minutes + ":" + secs;
      e++;
    }, 1000);
  }
  function endGame() {
    disableInteraction();
    checkDistance();
  }

  /***********************
   * Map / StreetView Functions
   ***********************/
  // Use our seededRandom() instead of Math.random() so that both players see the same sequence.
  function findRandomStreetView() {
    let attempts = 0;
    (function tryPanorama() {
      if (attempts >= 10) return findRandomStreetView();
      let lat = 140 * seededRandom() - 70;
      let lng = 360 * seededRandom() - 180;
      new google.maps.StreetViewService().getPanorama({
        location: { lat: lat, lng: lng },
        radius: isHardMode ? 50000 : 5000
      }, function(data, status) {
        if (status === "OK") {
          if (isHardMode) {
            new google.maps.Geocoder().geocode({
              location: data.location.latLng
            }, function(results, geocodeStatus) {
              if (geocodeStatus === "OK" && results[0]) {
                if (results[0].address_components.some(component => component.types.includes("locality"))) {
                  attempts++;
                  tryPanorama();
                } else {
                  updatePanorama(data.location.latLng);
                }
              } else {
                attempts++;
                tryPanorama();
              }
            });
          } else {
            updatePanorama(data.location.latLng);
          }
        } else {
          attempts++;
          tryPanorama();
        }
      });
    })();
  }
  function updatePanorama(latlng) {
    streetViewLatLng = latlng;
    showLoadingDialog(false);
    document.getElementById("pano").style.display = "block";
    document.getElementById("map").style.display = "block";
    let panoDiv = document.getElementById("pano");
    if (isStaticMode) {
      let url = `https://maps.googleapis.com/maps/api/streetview?size=800x600&location=${latlng.lat()},${latlng.lng()}&fov=90&heading=34&pitch=10&key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg`;
      panoDiv.innerHTML = `<img src="${url}" id="staticPano" style="width: 100%; height: 100%; object-fit: cover;">`;
    } else {
      panorama = new google.maps.StreetViewPanorama(panoDiv, {
        position: latlng,
        pov: { heading: 34, pitch: 10 },
        addressControl: false,
        linksControl: !isNoNavLinksMode,
        clickToGo: !isNoNavLinksMode,
        panControl: true,
        zoomControl: true,
        scrollwheel: true,
        disableDefaultUI: false,
        motionTracking: true,
        motionTrackingControl: true
      });
    }
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 0, lng: 0 },
      zoom: 1,
      disableDefaultUI: true
    });
    map.addListener("click", function(e) {
      if (userMarker) {
        userMarker.setPosition(e.latLng);
      } else {
        userMarker = new google.maps.Marker({
          position: e.latLng,
          map: map
        });
      }
    });
  }

  /***********************
   * Game Rounds and Next Map
   ***********************/
  // When checking the distance, display the result dialog. In multiplayer mode, show the Next Map button.
  function checkDistance() {
    if (!userMarker || !streetViewLatLng) {
      alert("Place a pin first!");
      return;
    }
    let distance = google.maps.geometry.spherical.computeDistanceBetween(userMarker.getPosition(), streetViewLatLng) / 1000;
    showGameOverDistanceDialog(`Distance: ${distance.toFixed(2)} km
Accuracy: ${Math.max(0, 100 - distance/100).toFixed(2)}%`);
    if (!actualMarker) {
      actualMarker = new google.maps.Marker({
        position: streetViewLatLng,
        map: userMarker.getMap(),
        icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" }
      });
    }
    if (isMultiplayerMode) {
      document.getElementById("nextMapButton").style.display = "inline-block";
    } else {
      document.getElementById("nextMapButton").style.display = "none";
    }
  }
  function nextMap() {
    document.getElementById("gameOverDistanceDialog").style.display = "none";
    if (userMarker) { userMarker.setMap(null); userMarker = null; }
    if (actualMarker) { actualMarker.setMap(null); actualMarker = null; }
    document.getElementById("pano").innerHTML = "";
    clearInterval(timerInterval);
    if (isTimedMode) {
      startTimer(timerDuration);
    } else {
      startStopwatch();
    }
    showLoadingDialog(true);
    findRandomStreetView();
  }
  function reopenMainMenu() {
    resetGame();
    closeGameOverDistanceDialog();
    forfeit();
  }
  function resetGame() {
    if (userMarker) { userMarker.setMap(null); userMarker = null; }
    if (actualMarker) { actualMarker.setMap(null); actualMarker = null; }
    map = null;
    panorama = null;
    document.getElementById("timer").textContent = "";
    clearInterval(timerInterval);
    document.getElementById("pano").innerHTML = "";
  }
  function disableInteraction() {
    if (panorama) {
      panorama.setOptions({ disableDefaultUI: true, clickableIcons: false });
    }
    if (map) {
      map.setOptions({ disableDefaultUI: true, draggable: false });
    }
  }

  /***********************
   * Event Listeners
   ***********************/
  // Show/hide the timer options.
  document.getElementById("timedMode").addEventListener("change", function() {
    document.getElementById("timerOptions").style.display = this.checked ? "block" : "none";
  });
  // Show/hide the multiplayer options.
  document.getElementById("multiplayerMode").addEventListener("change", function() {
    document.getElementById("multiplayerOptions").style.display = this.checked ? "block" : "none";
  });
  // In multiplayer mode, allow the user to press Enter (when the result dialog is open) to load the next map.
  document.addEventListener("keydown", function(e) {
    if (e.key === "Enter" &&
        document.getElementById("gameOverDistanceDialog").style.display === "block" &&
        isMultiplayerMode) {
      nextMap();
    }
  });
  window.initialize = initialize;
</script>
